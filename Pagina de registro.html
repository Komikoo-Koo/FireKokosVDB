<script>
    async function registrar() {
        await esperarFirebase(); // ðŸ”¥ Esperar hasta que Firebase estÃ© listo

        let nombre = document.getElementById("nombre").value.trim();
        let email = document.getElementById("email").value.trim();
        let password = document.getElementById("password").value.trim();

        if (nombre === "" || email === "" || password === "") {
            alert("Por favor, llena todos los campos.");
            return;
        }

        if (!window.auth || !window.db) {
            alert("Error: Firebase no estÃ¡ inicializado todavÃ­a.");
            return;
        }

        try {
            // ðŸ”¥ Registrar usuario en Firebase Authentication
            const userCredential = await window.auth.createUserWithEmailAndPassword(email, password);
            const uid = userCredential.user.uid;

            console.log("ðŸ”¥ UID del usuario autenticado:", uid);

            // ðŸ”¥ Esperar 2 segundos para que Firebase actualice la autenticaciÃ³n
            await new Promise(resolve => setTimeout(resolve, 2000));

            // ðŸ”¥ Verificar si el usuario sigue autenticado
            const user = window.auth.currentUser;
            if (!user) {
                console.error("ðŸ”¥ Error: Usuario no autenticado despuÃ©s del registro.");
                alert("Error: No se pudo autenticar correctamente.");
                return;
            }

            // ðŸ”¥ Determinar el rol basado en el correo (solo para prueba)
            let rolAsignado = email.includes("medico") ? "medico" : "paciente";

            // ðŸ”¥ Guardar en Firebase Database
            await window.db.ref("usuarios/" + uid).set({
                nombre: nombre,
                email: email,
                rol: rolAsignado
            });

            alert(`Usuario registrado correctamente con rol: ${rolAsignado}`);
        } catch (error) {
            console.error("ðŸ”¥ Error al registrar:", error);
            alert("Error al registrar usuario: " + error.message);
        }
    }
</script>
