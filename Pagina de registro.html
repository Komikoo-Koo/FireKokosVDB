<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Usuarios</title>

    <!-- Cargar Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-database-compat.js"></script>

    <!-- ğŸ”¥ Cargar configuraciÃ³n desde GitHub -->
    <script>
        async function cargarConfigFirebase() {
            try {
                const response = await fetch("https://raw.githubusercontent.com/Komikoo-Koo/FireKokosVDB/Scripts/firebase-config.js");
                const script = await response.text();
                eval(script); // ğŸ”¥ Carga la configuraciÃ³n de Firebase

                if (typeof firebaseConfig !== "undefined") {
                    firebase.initializeApp(firebaseConfig);

                    // ğŸ”¥ Definir auth y db despuÃ©s de inicializar Firebase
                    window.auth = firebase.auth();
                    window.db = firebase.database();

                    console.log("ğŸ”¥ Firebase inicializado correctamente.");

                    // ğŸ”¥ Verificar si la sesiÃ³n estÃ¡ iniciada al cargar la pÃ¡gina
                    window.auth.onAuthStateChanged((user) => {
                        if (user) {
                            console.log("âœ… SesiÃ³n activa:", user.email);
                        } else {
                            console.log("âŒ No hay sesiÃ³n iniciada.");
                        }
                    });

                } else {
                    console.error("ğŸ”¥ Error: No se pudo cargar la configuraciÃ³n de Firebase.");
                }
            } catch (error) {
                console.error("ğŸ”¥ Error al cargar Firebase Config:", error);
            }
        }

        cargarConfigFirebase(); // ğŸ”¥ Cargar configuraciÃ³n antes de ejecutar cualquier funciÃ³n
    </script>

    <script>
        async function registrar() {
            let nombre = document.getElementById("nombre").value.trim();
            let email = document.getElementById("email").value.trim();
            let password = document.getElementById("password").value.trim();

            if (nombre === "" || email === "" || password === "") {
                alert("Por favor, llena todos los campos.");
                return;
            }

            if (!window.auth || !window.db) {
                alert("Error: Firebase no estÃ¡ inicializado todavÃ­a.");
                return;
            }

            try {
                // ğŸ”¥ Registrar usuario en Firebase Authentication
                const userCredential = await window.auth.createUserWithEmailAndPassword(email, password);
                const uid = userCredential.user.uid;

                console.log("ğŸ”¥ UID del usuario autenticado:", uid);

                // ğŸ”¥ Esperar 2 segundos para que Firebase actualice la autenticaciÃ³n
                await new Promise(resolve => setTimeout(resolve, 2000));

                // ğŸ”¥ Verificar si el usuario sigue autenticado
                const user = window.auth.currentUser;
                if (!user) {
                    console.error("ğŸ”¥ Error: Usuario no autenticado despuÃ©s del registro.");
                    alert("Error: No se pudo autenticar correctamente.");
                    return;
                }

                // ğŸ”¥ Determinar el rol basado en el correo (solo para prueba)
                let rolAsignado = email.includes("medico") ? "medico" : "paciente";

                // ğŸ”¥ Guardar en Firebase Database
                await window.db.ref("usuarios/" + uid).set({
                    nombre: nombre,
                    email: email,
                    rol: rolAsignado
                });

                alert(`Usuario registrado correctamente con rol: ${rolAsignado}`);

                // ğŸ”¥ Confirmar que la sesiÃ³n sigue activa despuÃ©s del registro
                window.auth.onAuthStateChanged((user) => {
                    if (user) {
                        console.log("âœ… ConfirmaciÃ³n: sesiÃ³n sigue activa despuÃ©s del registro:", user.email);
                    } else {
                        console.error("ğŸ”¥ Error: La sesiÃ³n se cerrÃ³ inesperadamente despuÃ©s del registro.");
                    }
                });

            } catch (error) {
                console.error("ğŸ”¥ Error al registrar:", error);
                alert("Error al registrar usuario: " + error.message);
            }
        }
    </script>
</head>
<body>
    <h2>Registro de Usuarios</h2>
    <input type="text" id="nombre" placeholder="Nombre"><br>
    <input type="email" id="email" placeholder="Correo"><br>
    <input type="password" id="password" placeholder="ContraseÃ±a"><br>
    <button onclick="registrar()">Registrarse</button>
</body>
</html>
