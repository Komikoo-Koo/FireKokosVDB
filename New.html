<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Pacientes (Tiempo Real)</title>

    <style>
        :root {
            --bg-color: #f4f4f9;
            --text-color: #333;
            --accordion-bg: #007BFF;
            --accordion-hover: #0056b3;
            --panel-bg: white;
            --panel-border: #007BFF;
            --fecha-bg: #f9a825;
            --fecha-border: #f9a825;
        }
        
.usuario-info {
    position: absolute;
    top: 20px;
    right: 50px;
    display: flex;
    align-items: center;
    gap: 10px;
}

        #cerrar-sesion {
    flex-shrink: 0; /* Evita que el bot√≥n se reduzca o se mueva */
}

#usuario-email {
    font-weight: bold;
}
        
        body.dark-mode {
            --bg-color: #181818;
            --text-color: #ffffff;
            --accordion-bg: #444;
            --accordion-hover: #666;
            --panel-bg: #222;
            --panel-border: #666;
            --fecha-bg: #b58d00;
            --fecha-border: #b58d00;
        }

        body { 
            font-family: Arial, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; 
            padding: 0; 
            transition: 0.3s;
        }

        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: var(--bg-color);
            padding: 20px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
        }

        .buscador { margin-top: 10px; }
        
        input {
            padding: 10px;
            margin: 5px;
            width: 200px;
            font-size: 16px;
        }

        #lista-pacientes-container {
            margin-top: 210px;
            height: calc(100vh - 180px); 
            overflow-y: auto;
            padding: 20px;
        }

        .paciente, .fecha { margin-bottom: 10px; }

        .accordion {
            background-color: var(--accordion-bg);
            color: white;
            cursor: pointer;
            padding: 10px;
            width: 100%;
            text-align: left;
            border: none;
            outline: none;
            transition: 0.3s;
            font-size: 18px;
        }

        .active, .accordion:hover {
            background-color: var(--accordion-hover);
        }

        .panel {
            display: none;
            padding: 10px;
            background-color: var(--panel-bg);
            border-left: 3px solid var(--panel-border);
        }

        /* üî• Correcci√≥n: Se aplica el color correcto a las fechas */
        .fecha .accordion {
            background-color: var(--fecha-bg);
            border-left: 3px solid var(--fecha-border);
        }

        .fecha .active, .fecha .accordion:hover {
            background-color: var(--fecha-border);
        }

        #toggle-mode {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: var(--accordion-bg);
            color: white;
            border: none;
            transition: 0.3s;
        }

        #toggle-mode:hover {
            background-color: var(--accordion-hover);
        }
    </style>
</head>
<body>
    <div class="fixed-header">
    <h1>Lista de Pacientes</h1>

    <div class="usuario-info">
        <span id="usuario-email">Cargando...</span>
        <button id="cerrar-sesion" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
    </div>

    <button id="toggle-mode">üåô Modo Oscuro</button>
    
    <div class="buscador">
        <input type="text" id="buscar-paciente" placeholder="Buscar paciente..." oninput="filtrar()">
        <input type="text" id="buscar-fecha" placeholder="D√≠a Mes A√±o" oninput="filtrar()">
    </div>
</div>

<div id="lista-pacientes-container">
    <div id="lista-pacientes"></div>
</div>



    <!-- üî• Cargar Firebase (asegurar que est√© antes del script que lo usa) -->
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-database-compat.js"></script>

    <script>
        async function cargarConfigFirebase() {
            try {
                const response = await fetch("https://raw.githubusercontent.com/Komikoo-Koo/FireKokosVDB/Scripts/firebase-config.js");
                const script = await response.text();
                eval(script); // üî• Carga la configuraci√≥n de Firebase

                if (typeof firebaseConfig !== "undefined") {
                    firebase.initializeApp(firebaseConfig);
                    window.auth = firebase.auth();
                    window.db = firebase.database();

                    console.log("üî• Firebase inicializado correctamente.");
                    
                    // üî• Verificar si la sesi√≥n est√° iniciada
                    window.auth.onAuthStateChanged((user) => {
    if (user) {
        document.getElementById("usuario-email").textContent = user.email;
        console.log("‚úÖ Sesi√≥n activa:", user.email);
        cargarPacientes(); // üî• Solo cargamos pacientes si hay sesi√≥n
    } else {
        console.log("‚ùå No hay sesi√≥n iniciada.");
        window.location.href = "Pagina%20de%20registro.html";
    }
});



                } else {
                    console.error("üî• Error: No se pudo cargar la configuraci√≥n de Firebase.");
                }
            } catch (error) {
                console.error("üî• Error al cargar Firebase Config:", error);
            }
        }

        cargarConfigFirebase(); // üî• Cargar configuraci√≥n antes de ejecutar cualquier funci√≥n
    </script>

    <script>
    function cerrarSesion() {
        // Aseg√∫rate de tener referencia a `firebase.auth()`
        firebase.auth().signOut()
        .then(() => {
            console.log("Sesi√≥n cerrada con √©xito.");
            // Redirigir al usuario a la p√°gina de login o donde desees
            window.location.href = "Pagina%20de%20registro.html";
        })
        .catch((error) => {
            console.error("Error al cerrar sesi√≥n:", error);
        });
    }
</script>


    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const toggleBtn = document.getElementById("toggle-mode");

            function toggleDarkMode() {
                document.body.classList.toggle("dark-mode");
                const isDarkMode = document.body.classList.contains("dark-mode");
                localStorage.setItem("dark-mode", isDarkMode);
                toggleBtn.textContent = isDarkMode ? "‚òÄÔ∏è Modo Claro" : "üåô Modo Oscuro";
            }

            toggleBtn.addEventListener("click", toggleDarkMode);

            if (localStorage.getItem("dark-mode") === "true") {
                document.body.classList.add("dark-mode");
                toggleBtn.textContent = "‚òÄÔ∏è Modo Claro";
            }
        });
    </script>
    <script>
        let estadoDesplegables = {}; // üî• Guarda el estado de los acordeones

      async function cargarPacientes() {
    try {
        // üî• Esperar a que el usuario est√© autenticado
        window.auth.onAuthStateChanged(async (user) => {
            if (!user) {
                console.warn("‚ùå No hay usuario autenticado.");
                return;
            }

            console.log("üì° Usuario autenticado:", user.uid);

            // üî• Obtener el rol del usuario en Firebase
            const snapshot = await window.db.ref("usuarios/" + user.uid).once("value");
            const usuarioData = snapshot.val();

            if (!usuarioData) {
                console.error("‚ö† No se encontr√≥ informaci√≥n del usuario en la base de datos.");
                return;
            }

            console.log("üì° Datos del usuario:", usuarioData);

            // üîÑ Si el rol del usuario ha cambiado, forzar actualizaci√≥n del token
            user.getIdToken(true).then(() => {
                console.log("üîÑ Token actualizado, recargando datos...");
            }).catch((error) => {
                console.error("‚ö† Error al actualizar el token:", error);
            });

            // üî• Cargar datos dependiendo del rol
            if (usuarioData.rol === "medico") {
                console.log("‚úÖ Usuario es m√©dico, cargando todos los pacientes...");
                window.db.ref("Pacientes").on("value", actualizarListaPacientes);
            } else {
                console.log("‚úÖ Usuario es paciente, cargando solo su informaci√≥n...");
                window.db.ref("Pacientes/" + user.uid).on("value", actualizarListaPacientes);
            }
        });
    } catch (error) {
        console.error("üî• Error al cargar pacientes:", error);
    }
}



function actualizarListaPacientes(snapshot) {
    const datosFirebase = snapshot.val() || {};
    console.log("üî• Datos cargados correctamente:", datosFirebase);

    const listaPacientes = document.getElementById("lista-pacientes");
    listaPacientes.innerHTML = "";

    // üî• Verificar el usuario autenticado y esperar a que Firebase cargue completamente
    window.auth.onAuthStateChanged(async (user) => {
        if (!user) {
            console.warn("‚ùå No hay usuario autenticado.");
            return;
        }

        const snapshotUsuario = await window.db.ref("usuarios/" + user.uid).once("value");
        const usuarioData = snapshotUsuario.val();

        if (!usuarioData) {
            console.error("‚ö† No se encontr√≥ informaci√≥n del usuario en la base de datos.");
            return;
        }

        const esMedico = usuarioData.rol === "medico";

        Object.keys(datosFirebase).forEach((idPaciente) => {
            const pacienteData = datosFirebase[idPaciente];

            // üî• Si el usuario es paciente, solo debe ver su propio ID
            if (!esMedico && idPaciente !== user.uid) {
                return;
            }

            let nombrePaciente;
            let fechas;

            if (esMedico) {
                nombrePaciente = Object.keys(pacienteData)[0];
                fechas = pacienteData[nombrePaciente];
            } else {
                // üî• Si es paciente, su informaci√≥n comienza directamente desde su ID
                nombrePaciente = "Mis Registros";
                fechas = pacienteData;
            }

            if (!fechas) return;

            // üî• Crear la estructura para cada paciente
            const pacienteDiv = document.createElement("div");
            pacienteDiv.className = "paciente";
            pacienteDiv.innerHTML = `
                <button class="accordion">${nombrePaciente} ‚¨á</button>
                <div class="panel"></div>
            `;
            listaPacientes.appendChild(pacienteDiv);

            const panelPaciente = pacienteDiv.querySelector(".panel");

            Object.keys(fechas).forEach((fecha) => {
                const datos = fechas[fecha];

                // üî• Estructura para mostrar fechas y datos m√©dicos
                const fechaDiv = document.createElement("div");
                fechaDiv.className = "fecha";
                fechaDiv.innerHTML = `
                    <button class="accordion fecha-btn">${fecha} üìÖ</button>
                    <div class="panel fecha-panel">
                        ${datos.altura ? `<p><strong>Altura:</strong> ${datos.altura} cm</p>` : ""}
                        ${datos.temperatura ? `<p><strong>Temperatura:</strong> ${datos.temperatura} ¬∞C</p>` : ""}
                        ${datos.presion ? `<p><strong>Presi√≥n Arterial:</strong> ${datos.presion}</p>` : ""}
                        ${datos.ritmo_cardiaco ? `<p><strong>Ritmo Card√≠aco:</strong> ${datos.ritmo_cardiaco} bpm</p>` : ""}
                        ${datos.peso ? `<p><strong>Peso:</strong> ${datos.peso} kg</p>` : ""}
                    </div>
                `;
                panelPaciente.appendChild(fechaDiv);
            });
        });

        activarAccordion(); // üî• Mantiene la funcionalidad del acorde√≥n sin cambios
    });
}


        activarAccordion(); // üî• Mantiene la funcionalidad del acorde√≥n sin cambios
    });
}

        function activarAccordion() {
            document.querySelectorAll(".accordion").forEach((accordion) => {
                accordion.addEventListener("click", function () {
                    this.classList.toggle("active");
                    const panel = this.nextElementSibling;
                    panel.style.display = panel.style.display === "block" ? "none" : "block";

                    // üî• Guardar el estado de los acordeones
                    const pacienteDiv = this.closest(".paciente");
                    if (pacienteDiv) {
                        const paciente = pacienteDiv.querySelector(".accordion").textContent.trim();
                        if (!estadoDesplegables[paciente]) estadoDesplegables[paciente] = {};
                        if (this.classList.contains("fecha-btn")) {
                            const fecha = this.textContent.trim();
                            estadoDesplegables[paciente][fecha] = this.classList.contains("active");
                        } else {
                            estadoDesplegables[paciente]._abierto = this.classList.contains("active");
                        }
                    }
                });
            });
        }
    </script>
    <script>
        function filtrar() {
            let inputNombre = document.getElementById("buscar-paciente").value.toLowerCase();
            let inputFecha = document.getElementById("buscar-fecha").value.toLowerCase();
            let pacientes = document.querySelectorAll(".paciente");

            pacientes.forEach((paciente) => {
                let nombre = paciente.querySelector(".accordion").textContent.toLowerCase();
                let fechas = paciente.querySelectorAll(".fecha");

                let coincideNombre = inputNombre.length > 0 && nombre.includes(inputNombre);
                let fechaVisible = false;

                fechas.forEach((fechaDiv) => {
                    let fechaTexto = fechaDiv.querySelector(".fecha-btn").textContent.toLowerCase();
                    let coincideFecha = fechaTexto.includes(inputFecha);
                    fechaDiv.style.display = coincideFecha ? "block" : "none";
                    if (coincideFecha) fechaVisible = true;
                });

                // üî• L√≥gica para mostrar u ocultar pacientes seg√∫n filtros aplicados
                if (inputNombre.length > 0 && inputFecha.length > 0) {
                    paciente.style.display = coincideNombre && fechaVisible ? "block" : "none";
                } else if (inputNombre.length > 0) {
                    paciente.style.display = coincideNombre ? "block" : "none";
                    if (coincideNombre) mantenerFechasVisibles(paciente);
                } else if (inputFecha.length > 0) {
                    paciente.style.display = fechaVisible ? "block" : "none";
                } else {
                    paciente.style.display = "block";
                    fechas.forEach((fechaDiv) => (fechaDiv.style.display = "block"));
                }
            });

            // üîπ Si solo hay un paciente visible y se busca una fecha, se ocultan los dem√°s
            let visibles = Array.from(pacientes).filter((p) => p.style.display === "block");
            if (visibles.length === 1 && inputFecha.length > 0) {
                pacientes.forEach((p) => {
                    if (!visibles.includes(p)) p.style.display = "none";
                });
            }

            setTimeout(actualizarFechasVisibles, 100);
        }

        function actualizarFechasVisibles() {
            const pacientes = document.querySelectorAll(".paciente");
            pacientes.forEach((paciente) => {
                const fechas = paciente.querySelectorAll(".fecha");
                if (paciente.style.display === "block") {
                    fechas.forEach((fechaDiv) => {
                        let coincideFecha = true;
                        let fechaBtn = fechaDiv.querySelector(".fecha-btn");
                        if (!fechaBtn) return;
                        let fechaTexto = fechaBtn.textContent.toLowerCase();
                        if (document.getElementById("buscar-fecha").value.length > 0) {
                            let inputFecha = document.getElementById("buscar-fecha").value.toLowerCase();
                            coincideFecha = fechaTexto.includes(inputFecha);
                        }
                        fechaDiv.style.display = coincideFecha ? "block" : "none";
                    });
                }
            });
        }

        function mantenerFechasVisibles(paciente) {
            let panel = paciente.querySelector(".panel");
            let fechas = paciente.querySelectorAll(".fecha");
            if (panel.style.display === "block") {
                fechas.forEach((fechaDiv) => (fechaDiv.style.display = "block"));
            }
        }

        // üî• Configurar filtrado autom√°tico cada 50ms
        document.addEventListener("DOMContentLoaded", function () {
            setInterval(() => {
                filtrar();
            }, 50);
        });

        // üî• Iniciar carga de pacientes despu√©s de cargar Firebase
        cargarPacientes();
    </script>
</body>
</html>
